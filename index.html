<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>TraderArmy Stable</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
html,body{
  margin:0;padding:0;height:100%;
  background:#0e0e0e;color:#fff;font-family:Arial
}
header{
  background:#111;padding:10px;
  display:flex;gap:10px;
  border-bottom:1px solid #222
}
button,select{
  background:#1c1c1c;color:#fff;
  border:1px solid #333;
  padding:6px;border-radius:4px;
  cursor:pointer
}
#charts{
  display:grid;
  height:calc(100vh - 100px);
}
.chart-box{
  position:relative;
  border:1px solid #222;
}
.chart{
  width:100%;
  height:100%;
}

/* TOOLBAR */
#toolbar{
  position:fixed;
  top:80px;left:10px;
  background:#111;
  border:1px solid #333;
  padding:6px;
  border-radius:6px;
  display:flex;
  flex-direction:column;
  gap:6px;
  z-index:1000;
  cursor:move;
}
#toolbar button.active{
  background:#2962ff;
}

/* DRAW */
.draw-layer{
  position:absolute;
  inset:0;
  pointer-events:none;
}
.draw-layer.active{
  pointer-events:auto;
}
</style>
</head>

<body>

<header>
<strong>TraderArmy</strong>
<button onclick="setLayout(1)">1</button>
<button onclick="setLayout(2)">2</button>
<button onclick="setLayout(4)">4</button>
</header>

<div id="toolbar">
<button onclick="selectTool('trend',this)">Trend</button>
<button onclick="selectTool('hline',this)">Yatay</button>
<button onclick="exitDraw()">Çık</button>
</div>

<div id="charts"></div>

<script src="https://s3.tradingview.com/tv.js"></script>
<script>
/* ================= LAYOUT ================= */
let layout = 1;
const chartsDiv = document.getElementById("charts");

function setLayout(n){
  layout = n;
  render();
}

/* ================= RENDER ================= */
function render(){
  chartsDiv.innerHTML="";
  chartsDiv.style.gridTemplateColumns =
    layout===1?"1fr":
    layout===2?"1fr 1fr":
    "1fr 1fr";

  for(let i=0;i<layout;i++){
    const box=document.createElement("div");
    box.className="chart-box";
    box.innerHTML=`
      <div id="tv${i}" class="chart"></div>
      <canvas class="draw-layer"></canvas>
    `;
    chartsDiv.appendChild(box);

    new TradingView.widget({
      container_id:"tv"+i,
      autosize:true,
      symbol:"BINANCE:BTCUSDT",
      interval:"5",
      theme:"dark",
      locale:"tr"
    });

    initDraw(box.querySelector(".draw-layer"));
  }
}
render();

/* ================= TOOLBAR DRAG ================= */
const toolbar=document.getElementById("toolbar");
let drag=false,dx=0,dy=0;
toolbar.onmousedown=e=>{
  drag=true;
  dx=e.clientX-toolbar.offsetLeft;
  dy=e.clientY-toolbar.offsetTop;
};
document.onmousemove=e=>{
  if(!drag) return;
  toolbar.style.left=(e.clientX-dx)+"px";
  toolbar.style.top=(e.clientY-dy)+"px";
};
document.onmouseup=()=>drag=false;

/* ================= DRAW ================= */
let tool=null;
function selectTool(t,btn){
  tool=t;
  document.querySelectorAll("#toolbar button")
    .forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  document.querySelectorAll(".draw-layer")
    .forEach(c=>c.classList.add("active"));
}
function exitDraw(){
  tool=null;
  document.querySelectorAll("#toolbar button")
    .forEach(b=>b.classList.remove("active"));
  document.querySelectorAll(".draw-layer")
    .forEach(c=>c.classList.remove("active"));
}

function initDraw(canvas){
  const ctx=canvas.getContext("2d");
  function resize(){
    canvas.width=canvas.offsetWidth;
    canvas.height=canvas.offsetHeight;
  }
  resize(); window.addEventListener("resize",resize);

  let start=null;
  canvas.onmousedown=e=>{
    if(!tool) return;
    start={x:e.offsetX,y:e.offsetY};
  };
  canvas.onmouseup=e=>{
    if(!start) return;
    ctx.strokeStyle="#f5c542";
    ctx.lineWidth=2;
    ctx.beginPath();
    if(tool==="hline"){
      ctx.moveTo(0,e.offsetY);
      ctx.lineTo(canvas.width,e.offsetY);
    }else{
      ctx.moveTo(start.x,start.y);
      ctx.lineTo(e.offsetX,e.offsetY);
    }
    ctx.stroke();
    start=null;
    exitDraw();
  };
}
</script>

</body>
</html>
