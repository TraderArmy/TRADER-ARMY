<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRADE ARMY | V.1 - REPAIR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body { background: #0c0d10; margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; color: #d1d4dc; font-family: 'Inter', sans-serif; }
        #chart-grid { display: grid; height: 100%; width: 100%; gap: 1px; background: #1e222d; }
        .grid-1 { grid-template-columns: 1fr; }
        .grid-2 { grid-template-columns: 1fr 1fr; }
        .grid-4 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }
        
        .side-panel { width: 280px; background: #131722; border-left: 1px solid #1e222d; transition: 0.3s; }
        .side-panel.closed { width: 0; overflow: hidden; border-left: none; }

        .control-btn { background: #1e222d; color: #81858e; border: 1px solid #2a2e39; padding: 5px 12px; border-radius: 4px; font-size: 11px; font-weight: bold; cursor: pointer; }
        .active-layout { background: #2962ff !important; color: white !important; }
        .header-ticker { height: 40px; background: #131722; border-bottom: 1px solid #1e222d; }
    </style>
</head>
<body class="flex flex-col">

    <div class="header-ticker shrink-0">
        <div class="tradingview-widget-container">
            <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
            { "symbols": [
                {"proName": "NASDAQ:IXIC", "title": "NASDAQ"},
                {"proName": "BITSTAMP:BTCUSD", "title": "BTC/USD"},
                {"proName": "FX_IDC:USDTRY", "title": "USD/TRY"},
                {"proName": "TVC:GOLD", "title": "ALTIN"}
            ], "colorTheme": "dark", "isTransparent": true, "locale": "tr" }
            </script>
        </div>
    </div>

    <header class="h-16 border-b border-[#1e222d] bg-[#131722] flex items-center justify-between px-4 shrink-0 z-50">
        <div class="flex items-center space-x-4">
            <div class="flex flex-col">
                <span class="text-white font-black italic text-lg tracking-tighter uppercase">TRADE ARMY</span>
                <span class="text-blue-500 text-[10px] font-bold tracking-[3px]">PRO TERMINAL</span>
            </div>
            
            <button id="notifBtn" onclick="requestPermission()" class="bg-orange-600 hover:bg-orange-500 text-white text-[10px] px-3 py-1 rounded font-bold transition">
                ðŸ”” BÄ°LDÄ°RÄ°MLERÄ° AKTÄ°FLEÅžTÄ°R
            </button>
        </div>

        <div class="flex items-center space-x-2 bg-black/40 p-2 rounded border border-gray-800">
            <input type="text" id="alarmSym" placeholder="BTCUSDT" class="bg-transparent text-xs w-20 outline-none text-blue-500 font-bold uppercase">
            <input type="number" id="alarmPrice" placeholder="Fiyat" class="bg-transparent text-xs w-20 outline-none text-white">
            <button onclick="saveAlarm()" class="bg-blue-600 px-3 py-1 rounded text-[10px] font-bold">EKLE</button>
        </div>

        <div class="flex items-center space-x-3">
            <button onclick="toggleSidePanel()" class="control-btn">ðŸ“Š LÄ°STE AÃ‡/KAPAT</button>
            <div id="clock" class="text-white font-mono text-sm font-bold hidden md:block">00:00:00</div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        <aside class="w-14 border-r border-[#1e222d] bg-[#0c0d10] flex flex-col items-center py-4 space-y-6 shrink-0">
            <button onclick="updateSymbol('BINANCE:BTCUSDT')" title="BTC" class="text-xl">â‚¿</button>
            <button onclick="updateSymbol('NASDAQ:IXIC')" title="Nasdaq" class="text-xl">ðŸ“ˆ</button>
            <button onclick="updateSymbol('TVC:GOLD')" title="AltÄ±n" class="text-xl">ðŸŸ¡</button>
        </aside>

        <main class="flex-1 bg-black overflow-hidden">
            <div id="chart-grid" class="grid-1">
                <div id="tv_1" class="w-full h-full"></div>
            </div>
        </main>

        <aside id="sidePanel" class="side-panel p-3 flex flex-col">
            <div class="text-[10px] font-bold text-gray-500 mb-4 tracking-widest uppercase border-b border-gray-800 pb-2">Aktif Alarmlar</div>
            <div id="alarmList" class="flex-1 space-y-2 overflow-y-auto"></div>
        </aside>
    </div>

    <audio id="beep" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script>
        let alarmlar = JSON.parse(localStorage.getItem('alarms')) || [];
        let currentSymbol = 'BINANCE:BTCUSDT';

        // BÄ°LDÄ°RÄ°M Ä°ZNÄ° FONKSÄ°YONU
        function requestPermission() {
            Notification.requestPermission().then(perm => {
                if(perm === "granted") {
                    document.getElementById('notifBtn').classList.add('hidden');
                    new Notification("TRADE ARMY", { body: "Bildirimler ve Alarmlar HazÄ±r!" });
                }
            });
        }

        // PANEL AÃ‡-KAPAT
        function toggleSidePanel() {
            document.getElementById('sidePanel').classList.toggle('closed');
        }

        // ALARM KAYDETME
        function saveAlarm() {
            const sym = document.getElementById('alarmSym').value.toUpperCase();
            const prc = parseFloat(document.getElementById('alarmPrice').value);
            if(!sym || !prc) return alert("Bilgileri girin!");
            
            alarmlar.push({ id: Date.now(), symbol: sym, price: prc, active: true });
            localStorage.setItem('alarms', JSON.stringify(alarmlar));
            renderAlarms();
        }

        function renderAlarms() {
            const list = document.getElementById('alarmList');
            list.innerHTML = alarmlar.map(a => `
                <div class="bg-black/30 p-2 rounded border border-gray-800 flex justify-between items-center ${!a.active ? 'opacity-30' : ''}">
                    <span class="text-xs font-mono">${a.symbol} <br> <b class="text-blue-500">${a.price}</b></span>
                    <button onclick="deleteAlarm(${a.id})" class="text-red-900 font-bold text-[10px]">SÄ°L</button>
                </div>
            `).join('');
        }

        function deleteAlarm(id) {
            alarmlar = alarmlar.filter(a => a.id !== id);
            localStorage.setItem('alarms', JSON.stringify(alarmlar));
            renderAlarms();
        }

        // CANLI FÄ°YAT VE ALARM TETÄ°KLEME (WebSocket)
        const socket = new WebSocket('wss://stream.binance.com:9443/ws/!ticker@arr');
        socket.onmessage = (e) => {
            const data = JSON.parse(e.data);
            alarmlar.forEach(alarm => {
                if(!alarm.active) return;
                const match = data.find(p => p.s === alarm.symbol);
                if(match) {
                    const price = parseFloat(match.c);
                    // Basit tetikleyici (yaklaÅŸÄ±k deÄŸer)
                    if(Math.abs(price - alarm.price) / alarm.price < 0.0005) {
                        fireAlarm(alarm);
                    }
                }
            });
        };

        function fireAlarm(a) {
            a.active = false;
            localStorage.setItem('alarms', JSON.stringify(alarmlar));
            renderAlarms();
            document.getElementById('beep').play();
            if(Notification.permission === "granted") {
                new Notification("ðŸš¨ ALARM!", { body: `${a.symbol} hedef fiyata ulaÅŸtÄ±: ${a.price}` });
            }
        }

        function initChart(id, symbol) {
            new TradingView.widget({ "autosize": true, "symbol": symbol, "interval": "60", "theme": "dark", "container_id": id, "locale": "tr" });
        }

        function updateSymbol(s) {
            currentSymbol = s;
            initChart('tv_1', s);
        }

        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString(); }, 1000);
        window.onload = () => { 
            initChart('tv_1', currentSymbol); 
            renderAlarms(); 
            if(Notification.permission === "granted") document.getElementById('notifBtn').classList.add('hidden');
        };
    </script>
</body>
</html>
